version: '3.8'

services:
  api:
    build:
      context: ./backend
    container_name: workflow-api
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      # Supabase (optional): supply via a .env file or environment
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    networks:
      - ai-workflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  # portal-ui (production) disabled for now; use portal-ui-dev instead
  # portal-ui:
  #   build: .
  #   container_name: portal-ui
  #   ports:
  #     - "3002:3002"
  #   environment:
  #     - NODE_ENV=production
  #     - NEXT_PUBLIC_API_URL=http://localhost:5000
  #     - NEXT_PUBLIC_ACTIVEPIECES_URL=http://localhost:8080
  #     - NEXT_PUBLIC_FLOWISE_URL=http://localhost:3000
  #     - NEXT_PUBLIC_TEMPORAL_URL=http://localhost:8088
  #     - NEXT_PUBLIC_GRAFANA_URL=http://localhost:3001
  #     - NEXT_PUBLIC_NANGO_URL=http://localhost:3003
  #     - NEXT_PUBLIC_APP_NAME=AI Workflow Portal
  #     - NEXT_PUBLIC_APP_VERSION=3.0.0
  #   networks:
  #     - ai-workflow-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:3002 || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # Development container with hot reload (HMR)
  portal-ui-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: portal-ui-dev
    command: npm run dev -- -p 3002
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - NEXT_WEBPACK_USEPOLLING=1
      - NEXT_PUBLIC_API_URL=http://localhost:5000
      - NEXT_PUBLIC_DEMO_MODE=false
      - NEXT_PUBLIC_APP_NAME=AI Workflow Portal
      - NEXT_PUBLIC_APP_VERSION=3.0.0
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    ports:
      - "3002:3002"
    volumes:
      - .:/app
      - /app/node_modules
    networks:
      - ai-workflow-network
    restart: unless-stopped

networks:
  ai-workflow-network:
    driver: bridge