services:
  api:
    build:
      context: ./backend
    container_name: workflow-api
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - ALLOW_MOCK_AUTH=true
      - PUBLIC_PORTAL_URL=${PUBLIC_PORTAL_URL:-http://localhost:3002}
      # LLM / OpenAI configuration (ensure OPENAI_API_KEY is set in your .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_DEFAULT_MODEL=${OPENAI_DEFAULT_MODEL:-gpt-4o-mini}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - LLM_CACHE_ENABLED=${LLM_CACHE_ENABLED:-false}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - NANGO_HOST=${NANGO_HOST}
      - NANGO_SECRET_KEY=${NANGO_SECRET_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER}
      - DEFAULT_SMS_SENDER=${DEFAULT_SMS_SENDER}
      - NANGO_TWILIO_PROVIDER_CONFIG_KEY=${NANGO_TWILIO_PROVIDER_CONFIG_KEY}
      - NANGO_TWILIO_CONNECTION_ID=${NANGO_TWILIO_CONNECTION_ID}
      - NANGO_EMAIL_PROVIDER_CONFIG_KEY=${NANGO_EMAIL_PROVIDER_CONFIG_KEY}
      - NANGO_EMAIL_CONNECTION_ID=${NANGO_EMAIL_CONNECTION_ID}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - DEFAULT_EMAIL_SENDER=${DEFAULT_EMAIL_SENDER}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - DEFAULT_WHATSAPP_SENDER=${DEFAULT_WHATSAPP_SENDER}
      - NANGO_WHATSAPP_PROVIDER_CONFIG_KEY=${NANGO_WHATSAPP_PROVIDER_CONFIG_KEY}
      - NANGO_WHATSAPP_CONNECTION_ID=${NANGO_WHATSAPP_CONNECTION_ID}
    networks:
      - ai-workflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  portal-ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: portal-ui
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://api:5000
      - NEXT_PUBLIC_APP_NAME=AI Workflow Portal
      - NEXT_PUBLIC_APP_VERSION=3.0.0
      - NEXT_PUBLIC_NANGO_URL=${NEXT_PUBLIC_NANGO_URL}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    depends_on:
      - api
    ports:
      - "3002:3002"
    networks:
      - ai-workflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3002 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Development container with hot reload (HMR)
  portal-ui-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: portal-ui-dev
    command: npm run dev -- -p 3002
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - NEXT_WEBPACK_USEPOLLING=1
      - NEXT_PUBLIC_API_URL=http://api:5000
      - NEXT_PUBLIC_DEMO_MODE=false
      - NEXT_PUBLIC_APP_NAME=AI Workflow Portal
      - NEXT_PUBLIC_APP_VERSION=3.0.0
      # Optional: show Nango URL in the UI if needed
      - NEXT_PUBLIC_NANGO_URL=${NEXT_PUBLIC_NANGO_URL}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    ports:
      - "3002:3002"
    volumes:
      - .:/app
    networks:
      - ai-workflow-network
    restart: unless-stopped

networks:
  ai-workflow-network:
    driver: bridge